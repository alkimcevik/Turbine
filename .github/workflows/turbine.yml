name: 'Turbine CI'

on:
  # push:
  #   branches:
  #     - master
  # pull_request:
  #   branches:
  #     - master
  # schedule:
  #   - cron: '45 11 * * 1' # Runs every Monday at 11:45 AM UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PY_COLORS: "1"
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        python-version: ["3.10"]

    steps:
    # Step 1: Checkout repository
    - uses: actions/checkout@v4

    # Step 2: Set up Python environment
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install --upgrade wheel
        pip install -r requirements.txt

    # Step 4: Install and update SeleniumBase
    - name: Install SeleniumBase
      run: |
        python setup.py install
        pip install -U seleniumbase

    # Step 5: Install chromedriver
    - name: Install chromedriver
      run: |
        seleniumbase install chromedriver

    # Step 6: Install and run Flake8 Linter
    - name: Install Flake8
      run: pip install flake8
    - name: Run Flake8 Linter
      continue-on-error: true
      run: flake8 examples/nypl_tests --max-line-length=120 --statistics --count || true

    # Step 7: Run a quick pytest check
    - name: Make sure pytest is working
      run: |
        echo "def test_1(): pass" > nothing.py
        pytest nothing.py

    # Step 8: Run all tests
    - name: Run all tests
      continue-on-error: true
      run: |
        pytest examples/nypl_tests --headless --browser=chrome --rs -v -s -n=6 --reruns=2 --reruns-delay=1 --ignore=examples/nypl_tests/test_mobile.py --alluredir=reports/allure-results

    # Step 9: Run mobile-specific tests
    - name: Run test_mobile.py
      continue-on-error: true
      run: |
        pytest examples/nypl_tests/test_mobile.py --rs -v -s -n=6 --reruns=2 --reruns-delay=1 --mobile --alluredir=reports/allure-results

    # Step 10: Get Allure history (optional for scheduled runs)
    - name: Get Allure history
      uses: actions/checkout@v2
      if: github.event_name == 'schedule'
      continue-on-error: true
      with:
        ref: gh-pages
        path: gh-pages

    # Step 11: Generate Allure report
    - name: Generate Allure report
      uses: simple-elf/allure-report-action@master
      if: github.event_name == 'schedule'
      with:
        allure_results: reports/allure-results
        allure_history: allure-history

    # Step 12: Deploy report to GitHub Pages
    - name: Deploy report to GitHub Pages
      if: github.event_name == 'schedule'
      uses: peaceiris/actions-gh-pages@v2
      env:
        PERSONAL_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        publish_branch: gh-pages
        publish_dir: allure-history

    # # Step 13: Send Slack Notification (optional)
    # - name: Slack Notification
    #   if: github.event_name == 'schedule'
    #   uses: rtCamp/action-slack-notify@v2
    #   env:
    #     SLACK_CHANNEL: test_reports
    #     SLACK_COLOR: ${{ job.status }}
    #     SLACK_MESSAGE: 'https://alkimcevik.github.io/Turbine/'
    #     SLACK_TITLE: Turbine Test Results
    #     SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
